<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Telehand - 远程协助</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, "Segoe UI", sans-serif; background: #f5f5f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
.container { background: #fff; border-radius: 12px; box-shadow: 0 2px 20px rgba(0,0,0,0.1); padding: 28px; width: min(1080px, 96vw); text-align: center; }
h1 { font-size: 24px; margin-bottom: 4px; }
.role-subtitle { color: #6a778b; font-size: 13px; margin-bottom: 16px; }
.subtitle { color: #888; font-size: 14px; margin-bottom: 24px; }
textarea { width: 100%; height: 80px; border: 2px solid #ddd; border-radius: 8px; padding: 12px; font-size: 14px; resize: none; font-family: monospace; }
textarea:focus { outline: none; border-color: #4a90d9; }
.btn { display: inline-block; padding: 12px 32px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 16px; transition: background 0.2s; }
.btn-primary { background: #4a90d9; color: #fff; }
.btn-primary:hover { background: #357abd; }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }
.btn-danger { background: #e74c3c; color: #fff; }
.btn-danger:hover { background: #c0392b; }
.ip-box { background: #f0f7ff; border: 2px solid #4a90d9; border-radius: 8px; padding: 16px; margin: 16px 0; display: flex; align-items: center; justify-content: center; gap: 12px; }
.ip-text { font-size: 22px; font-weight: bold; font-family: monospace; color: #2c3e50; word-break: break-all; }
.btn-copy { padding: 6px 16px; font-size: 13px; background: #4a90d9; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
.btn-copy:hover { background: #357abd; }
.dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; }
.dot-green { background: #2ecc71; }
.log-area { text-align: left; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; padding: 12px; margin-top: 16px; height: 160px; overflow-y: auto; font-family: monospace; font-size: 12px; }
.log-line { padding: 2px 0; }
.log-time { color: #888; }
.log-method { color: #4a90d9; }
.log-path { color: #e6c07b; }
.debug-section { margin-top: 20px; text-align: left; }
.debug-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
.debug-title { font-size: 13px; color: #888; }
.debug-area { background: #0d1117; color: #8b949e; border-radius: 8px; padding: 12px; height: 180px; overflow-y: auto; font-family: monospace; font-size: 11px; white-space: pre-wrap; word-break: break-all; }
.phase-connecting { color: #f39c12; }
.error { color: #e74c3c; margin-top: 12px; }
.hidden { display: none; }
.cmd-section { text-align: left; background: #f9f6ee; border: 1px solid #edd9a4; border-radius: 8px; padding: 12px; margin-top: 14px; }
.cmd-title { color: #7a6130; font-size: 13px; margin-bottom: 8px; }
.cmd-row { margin-bottom: 8px; }
.cmd-platform { font-size: 12px; color: #666; margin-bottom: 4px; }
.cmd-entry { display: flex; align-items: stretch; gap: 8px; }
.cmd-text { flex: 1; font-family: monospace; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 8px; font-size: 12px; word-break: break-all; }
.cmd-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
.cmd-actions-inline { margin-top: 0; flex-wrap: nowrap; align-items: center; }
.peer-section { margin-top: 18px; text-align: left; }
.peer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
.peer-header-right { display: flex; gap: 8px; align-items: center; }
.peer-title { font-size: 14px; color: #555; }
.peer-updated { font-size: 12px; color: #8a8a8a; }
.peer-wrap { overflow-x: auto; border: 1px solid #ddd; border-radius: 8px; }
.peer-table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 940px; }
.peer-table th, .peer-table td { border-bottom: 1px solid #eee; padding: 7px 8px; text-align: left; white-space: nowrap; }
.peer-table th { background: #f7f8fb; color: #4a4a4a; }
.peer-self { background: #f0f9ff; }
.peer-hint { font-size: 12px; color: #888; margin-top: 8px; }
.baseline-box { margin-top: 12px; text-align: left; background: #f7f8fb; border: 1px solid #dfe3ee; border-radius: 8px; padding: 10px; font-size: 12px; color: #445; }
.baseline-row { margin: 2px 0; font-family: monospace; word-break: break-all; }
.session-copy-actions { margin-top: 8px; justify-content: center; }
@media (max-width: 640px) {
  .container { padding: 16px; }
  .ip-box { flex-direction: column; }
  .ip-text { font-size: 18px; }
  .cmd-entry { flex-direction: column; }
  .cmd-actions-inline { justify-content: flex-end; }
}
</style>
</head>
<body>
<div class="container">
  <h1>Telehand</h1>
  <p id="role-subtitle" class="role-subtitle">角色: 未知</p>

  <div id="phase-config">
    <p class="subtitle">请将对方发给你的配置码粘贴到下方</p>
    <textarea id="config-input" placeholder="在此粘贴配置码..."></textarea>
    <div id="config-error" class="error hidden"></div>
    <button class="btn btn-primary" id="btn-start" onclick="submitConfig()">启动远程协助</button>
  </div>

  <div id="phase-connecting" class="hidden">
    <p class="subtitle phase-connecting" id="connecting-status">正在连接网络，请稍候...</p>

    <div id="command-section-connecting" class="cmd-section hidden">
      <div class="cmd-title">在被控端执行以下命令（可复制）</div>
      <div id="command-list-connecting"></div>
    </div>

    <div class="peer-section">
      <div class="peer-header">
        <span class="peer-title" id="peer-title-connecting">Peer Info</span>
        <div class="peer-header-right">
          <span class="peer-updated" id="peer-updated-connecting">-</span>
        </div>
      </div>
      <div class="peer-wrap">
        <table class="peer-table">
          <thead>
            <tr>
              <th>Virtual IPv4</th>
              <th>Hostname</th>
              <th>Route Cost</th>
              <th>Protocol</th>
              <th>Latency</th>
              <th>Upload</th>
              <th>Download</th>
              <th>Loss Rate</th>
              <th>Version</th>
              <th>Role</th>
              <th>Local</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="peer-table-body-connecting">
            <tr><td colspan="12" class="peer-hint">等待网络数据...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="baseline-box">
      <div><strong>Connect Progress</strong></div>
      <div class="baseline-row" id="connecting-baseline-peer">current_peer: -</div>
      <div class="baseline-row" id="connecting-baseline-subnet">virtual_subnet: -</div>
      <div class="baseline-row" id="connecting-baseline-hash">network_hash: -</div>
      <div class="baseline-row" id="connecting-baseline-reason">last_switch_reason: -</div>
      <div class="baseline-row" id="connecting-baseline-endpoint">business_endpoint_status: -</div>
    </div>

    <div class="debug-section">
      <div class="debug-header">
        <span class="debug-title">Debug 日志</span>
        <button class="btn-copy" onclick="copyDebugLogs(this)">复制日志</button>
      </div>
      <div class="debug-area" id="debug-area-connecting"></div>
    </div>
  </div>

  <div id="phase-running" class="hidden">
    <p class="subtitle"><span class="dot dot-green"></span>远程协助已启动</p>
    <div class="ip-box">
      <span class="ip-text" id="virt-ip"></span>
    </div>
    <div id="session-copy-actions" class="cmd-actions session-copy-actions">
      <button class="btn-copy" onclick="copyConnectionInfo(this)">复制连接信息</button>
    </div>
    <p style="color:#888;font-size:13px;" id="port-info"></p>
    <p style="color:#888;font-size:13px;margin-top:4px;" id="running-hint">可在当前页面直接复制连接信息与给 AI 的 Prompt。</p>

    <div id="command-section" class="cmd-section hidden">
      <div class="cmd-title">在被控端执行以下命令（可复制）</div>
      <div id="command-list"></div>
    </div>

    <div class="peer-section">
      <div class="peer-header">
        <span class="peer-title" id="peer-title">Peer Info</span>
        <div class="peer-header-right">
          <span class="peer-updated" id="peer-updated">-</span>
        </div>
      </div>
      <div class="peer-wrap">
        <table class="peer-table">
          <thead>
            <tr>
              <th>Virtual IPv4</th>
              <th>Hostname</th>
              <th>Route Cost</th>
              <th>Protocol</th>
              <th>Latency</th>
              <th>Upload</th>
              <th>Download</th>
              <th>Loss Rate</th>
              <th>Version</th>
              <th>Role</th>
              <th>Local</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="peer-table-body">
            <tr><td colspan="12" class="peer-hint">等待网络数据...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="baseline-box">
      <div><strong>Session Baseline</strong></div>
      <div class="baseline-row" id="baseline-tun">tun_device: -</div>
      <div class="baseline-row" id="baseline-subnet">virtual_subnet: -</div>
      <div class="baseline-row" id="baseline-hash">network_hash: -</div>
      <div class="baseline-row" id="baseline-peer">current_peer: -</div>
      <div class="baseline-row" id="baseline-switch">last_switch_reason: -</div>
    </div>

    <div class="log-area" id="log-area"></div>
    <div class="debug-section">
      <div class="debug-header">
        <span class="debug-title">Debug 日志</span>
        <button class="btn-copy" onclick="copyDebugLogs(this)">复制日志</button>
      </div>
      <div class="debug-area" id="debug-area-running"></div>
    </div>
    <button class="btn btn-danger" style="margin-top:16px;" onclick="stopAgent()">断开连接</button>
  </div>

  <div id="phase-error" class="hidden">
    <p class="error" id="error-msg"></p>
    <p class="subtitle hidden" id="error-code"></p>
    <div class="debug-section">
      <div class="debug-header">
        <span class="debug-title">Debug 日志</span>
        <button class="btn-copy" onclick="copyDebugLogs(this)">复制日志</button>
      </div>
      <div class="debug-area" id="debug-area-error"></div>
    </div>
    <button class="btn btn-primary" style="margin-top:16px;" onclick="location.reload()">重试</button>
  </div>
</div>

<script>
const CONFIG_CODE_KEY = 'telehand_config_code';
let currentPhase = 'config';
let currentState = {};
let statePollTimer = null;
let logPollTimer = null;
let debugPollTimer = null;
let peerPollTimer = null;
let cachedDebugLogs = [];
let latestPeerSnapshot = null;
let lastNonEmptyPeerSnapshot = null;
let lastNonSelfPeerSnapshot = null;
let lastNonSelfPeerSnapshotAt = 0;
const PEER_POLL_INTERVAL_MS = 3000;
const CONNECTING_PEER_STALE_TTL_MS = 6000;

function normalizePhase(phase) {
  if (phase === 'init') return 'config';
  return ['config', 'connecting', 'running', 'error'].includes(phase) ? phase : 'config';
}

function startStatePoller() {
  if (statePollTimer !== null) return;
  statePollTimer = setInterval(pollState, 1000);
}

function startLogPoller() {
  if (logPollTimer !== null) return;
  logPollTimer = setInterval(pollLogs, 2000);
}

function startDebugPoller() {
  if (debugPollTimer !== null) return;
  debugPollTimer = setInterval(pollDebugLogs, 1000);
}

function startPeerPoller() {
  if (peerPollTimer !== null) return;
  peerPollTimer = setInterval(pollPeerInfo, PEER_POLL_INTERVAL_MS);
}

function stopLogPoller() {
  if (logPollTimer !== null) {
    clearInterval(logPollTimer);
    logPollTimer = null;
  }
}

function stopDebugPoller() {
  if (debugPollTimer !== null) {
    clearInterval(debugPollTimer);
    debugPollTimer = null;
  }
}

function stopPeerPoller() {
  if (peerPollTimer !== null) {
    clearInterval(peerPollTimer);
    peerPollTimer = null;
  }
}

function stopAllPollers() {
  if (statePollTimer !== null) {
    clearInterval(statePollTimer);
    statePollTimer = null;
  }
  stopLogPoller();
  stopDebugPoller();
  stopPeerPoller();
}

function syncPollersByPhase(phase) {
  startStatePoller();
  if (phase === 'running') {
    startLogPoller();
    startDebugPoller();
    startPeerPoller();
    return;
  }
  if (phase === 'connecting') {
    stopLogPoller();
    startDebugPoller();
    startPeerPoller();
    return;
  }
  if (phase === 'error') {
    stopLogPoller();
    startDebugPoller();
    stopPeerPoller();
    return;
  }
  stopLogPoller();
  stopDebugPoller();
  stopPeerPoller();
}

function restoreConfigInputFromSession() {
  try {
    const cached = sessionStorage.getItem(CONFIG_CODE_KEY);
    if (cached !== null) {
      document.getElementById('config-input').value = cached;
    }
  } catch (e) {}
}

function bindConfigInputPersistence() {
  const input = document.getElementById('config-input');
  input.addEventListener('input', () => {
    try {
      sessionStorage.setItem(CONFIG_CODE_KEY, input.value);
    } catch (e) {}
  });
}

function clearConfigInputSession() {
  try {
    sessionStorage.removeItem(CONFIG_CODE_KEY);
  } catch (e) {}
}

function renderRole(state) {
  const role = state && state.role ? state.role : 'unknown';
  document.getElementById('role-subtitle').textContent = '角色: ' + role;
  updatePeerTitle(
    state && state.network_owner ? String(state.network_owner) : '',
    state && state.network_hash ? String(state.network_hash) : ''
  );
  const hint = document.getElementById('running-hint');
  if (role === 'client') {
    hint.textContent = '接收协助端进入 running 后，可在当前页面直接复制连接信息或给 AI 的 Prompt。';
  } else {
    hint.textContent = '连接信息会同步显示在发起协助端 Web GUI，无需手动回传。';
  }
}

function updatePeerTitle(networkOwner, networkHash) {
  const owner = networkOwner ? String(networkOwner).trim() : '';
  const hash = networkHash ? String(networkHash).trim() : '';
  let text = 'Peer Info';
  if (owner && hash) {
    text = 'Peer Info (' + owner + ':' + hash + ')';
  } else if (owner || hash) {
    text = 'Peer Info (' + (owner || hash) + ')';
  }
  const title = document.getElementById('peer-title');
  const titleConnecting = document.getElementById('peer-title-connecting');
  if (title) title.textContent = text;
  if (titleConnecting) titleConnecting.textContent = text;
}

function renderConnecting(state) {
  renderRole(state);
  const status = state && state.business_endpoint_status ? String(state.business_endpoint_status) : '业务端还未连接，等待中...';
  document.getElementById('connecting-status').textContent = status;
  document.getElementById('connecting-baseline-peer').textContent = 'current_peer: ' + ((state && state.current_peer) ? state.current_peer : '-');
  document.getElementById('connecting-baseline-subnet').textContent = 'virtual_subnet: ' + ((state && state.virtual_subnet) ? state.virtual_subnet : '-');
  document.getElementById('connecting-baseline-hash').textContent = 'network_hash: ' + ((state && state.network_hash) ? state.network_hash : '-');
  document.getElementById('connecting-baseline-reason').textContent = 'last_switch_reason: ' + ((state && state.last_switch_reason) ? state.last_switch_reason : '-');
  document.getElementById('connecting-baseline-endpoint').textContent = 'business_endpoint_status: ' + status;
  renderCommands(state);
}

function renderRunning(state) {
  renderRole(state);
  const virtIP = state && state.virt_ip ? state.virt_ip : '';
  const apiPort = state && typeof state.api_port === 'number' ? state.api_port : 0;
  const endpoint = virtIP && apiPort ? virtIP + ':' + apiPort : '';
  document.getElementById('virt-ip').textContent = endpoint;
  document.getElementById('port-info').textContent = endpoint ? ('API 地址: http://' + endpoint) : '';
  document.getElementById('session-copy-actions').classList.toggle('hidden', !endpoint);
  document.getElementById('baseline-tun').textContent = 'tun_device: ' + ((state && state.tun_device) ? state.tun_device : '-');
  document.getElementById('baseline-subnet').textContent = 'virtual_subnet: ' + ((state && state.virtual_subnet) ? state.virtual_subnet : '-');
  document.getElementById('baseline-hash').textContent = 'network_hash: ' + ((state && state.network_hash) ? state.network_hash : '-');
  document.getElementById('baseline-peer').textContent = 'current_peer: ' + ((state && state.current_peer) ? state.current_peer : '-');
  document.getElementById('baseline-switch').textContent = 'last_switch_reason: ' + ((state && state.last_switch_reason) ? state.last_switch_reason : '-');
  renderCommands(state);
}

function hasPeerRows(snapshot) {
  return !!(snapshot && Array.isArray(snapshot.peers) && snapshot.peers.length > 0);
}

function nonSelfPeers(snapshot) {
  if (!snapshot || !Array.isArray(snapshot.peers)) {
    return [];
  }
  return snapshot.peers.filter((p) => !(p && p.is_self));
}

function hasNonSelfPeerRows(snapshot) {
  return nonSelfPeers(snapshot).length > 0;
}

function peerRowKey(p) {
  if (!p || typeof p !== 'object') {
    return '';
  }
  const id = p.peer_id ? String(p.peer_id).trim() : '';
  if (id) {
    return 'id:' + id;
  }
  const ip = p.virtual_ipv4 ? String(p.virtual_ipv4).trim() : '';
  const host = p.hostname ? String(p.hostname).trim() : '';
  const role = p.role ? String(p.role).trim() : '';
  return 'key:' + ip + '|' + host + '|' + role;
}

function cloneSnapshot(snapshot) {
  if (!snapshot || typeof snapshot !== 'object') {
    return null;
  }
  const peers = Array.isArray(snapshot.peers) ? snapshot.peers.map((p) => Object.assign({}, p)) : [];
  return {
    updated_at: snapshot.updated_at || '',
    network_owner: snapshot.network_owner || '',
    network_hash: snapshot.network_hash || '',
    peers: peers,
  };
}

function mergeSnapshotWithCachedNonSelf(incoming, cached) {
  const base = cloneSnapshot(incoming);
  if (!base) {
    return cloneSnapshot(cached);
  }
  const cachedPeers = nonSelfPeers(cached);
  if (cachedPeers.length === 0) {
    return base;
  }

  const seen = new Set();
  base.peers.forEach((p) => {
    const key = peerRowKey(p);
    if (key) {
      seen.add(key);
    }
  });

  cachedPeers.forEach((p) => {
    const key = peerRowKey(p);
    if (!key || seen.has(key)) {
      return;
    }
    const row = Object.assign({}, p);
    const host = row.hostname ? String(row.hostname).trim() : '';
    if (host && !host.includes('(缓存)')) {
      row.hostname = host + ' (缓存)';
    }
    base.peers.push(row);
    seen.add(key);
  });
  return base;
}

function buildConnectingFallbackSnapshot(state) {
  const currentPeer = state && state.current_peer ? String(state.current_peer).trim() : '';
  if (!currentPeer) {
    return null;
  }
  const selfRole = state && state.role ? String(state.role).trim() : '-';
  const selfIP = state && state.virt_ip ? String(state.virt_ip).trim() : '-';
  return {
    updated_at: '',
    network_owner: state && state.network_owner ? String(state.network_owner) : '',
    network_hash: state && state.network_hash ? String(state.network_hash) : '',
    peers: [
      {
        virtual_ipv4: selfIP || '-',
        hostname: '(self)',
        route_cost: 'Local',
        protocol: '-',
        latency: '-',
        upload: '-',
        download: '-',
        loss_rate: '-',
        version: '-',
        role: selfRole || '-',
        is_self: true,
      },
      {
        virtual_ipv4: '-',
        hostname: currentPeer,
        route_cost: '-',
        protocol: '-',
        latency: '-',
        upload: '-',
        download: '-',
        loss_rate: '-',
        version: '-',
        role: 'candidate',
        is_self: false,
      },
    ],
  };
}

function renderPeerTable(snapshot, bodyId, updatedId, stale) {
  const body = document.getElementById(bodyId);
  const updated = document.getElementById(updatedId);
  if (!body || !updated) {
    return;
  }
  if (!snapshot || !Array.isArray(snapshot.peers) || snapshot.peers.length === 0) {
    body.innerHTML = '<tr><td colspan="12" class="peer-hint">等待网络数据...</td></tr>';
    updated.textContent = '-';
    return;
  }

  body.innerHTML = snapshot.peers.map((p, idx) => {
    const cls = p.is_self ? 'peer-self' : '';
    const local = p.is_self ? '*' : '';
    const action = (hasVirtualIPv4(p && p.virtual_ipv4) && !isClientRole(p && p.role))
      ? '<button class="btn-copy" data-peer-idx="' + idx + '" data-body-id="' + escapeHtml(bodyId) + '">复制给 AI 的 Prompt</button>'
      : '-';
    return '<tr class="' + cls + '">' +
      '<td>' + escapeHtml(p.virtual_ipv4 || '-') + '</td>' +
      '<td>' + escapeHtml(p.hostname || '-') + '</td>' +
      '<td>' + escapeHtml(p.route_cost || '-') + '</td>' +
      '<td>' + escapeHtml(p.protocol || '-') + '</td>' +
      '<td>' + escapeHtml(p.latency || '-') + '</td>' +
      '<td>' + escapeHtml(p.upload || '-') + '</td>' +
      '<td>' + escapeHtml(p.download || '-') + '</td>' +
      '<td>' + escapeHtml(p.loss_rate || '-') + '</td>' +
      '<td>' + escapeHtml(p.version || '-') + '</td>' +
      '<td>' + escapeHtml(p.role || '-') + '</td>' +
      '<td>' + local + '</td>' +
      '<td>' + action + '</td>' +
      '</tr>';
  }).join('');

  body.querySelectorAll('button[data-peer-idx]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const rawIdx = btn.getAttribute('data-peer-idx');
      const idx = Number(rawIdx);
      if (!Number.isInteger(idx) || idx < 0) return;
      const peers = snapshot && Array.isArray(snapshot.peers) ? snapshot.peers : [];
      if (idx >= peers.length) return;
      copyAIPromptForPeer(peers[idx], btn);
    });
  });

  if (snapshot.updated_at) {
    updated.textContent = '更新时间: ' + snapshot.updated_at + (stale ? ' (缓存)' : '');
  } else {
    updated.textContent = stale ? '更新时间: - (缓存)' : '-';
  }
}

function renderCommands(state) {
  const commands = state && Array.isArray(state.commands) ? state.commands : [];
  const rows = [];
  commands.forEach((item) => {
    const platform = item && item.platform ? String(item.platform).trim() : '';
    const command = item && item.command ? String(item.command).trim() : '';
    if (!command) return;
    rows.push({
      platform: platform || '未知平台',
      command: command,
    });
  });

  renderCommandSection('command-section', 'command-list', rows);
  renderCommandSection('command-section-connecting', 'command-list-connecting', rows);
}

function renderCommandSection(sectionId, listId, rows) {
  const section = document.getElementById(sectionId);
  const list = document.getElementById(listId);
  if (!section || !list) {
    return;
  }

  list.innerHTML = '';
  if (!rows || rows.length === 0) {
    section.classList.add('hidden');
    return;
  }

  rows.forEach((item) => {
    const row = document.createElement('div');
    row.className = 'cmd-row';

    const platform = document.createElement('div');
    platform.className = 'cmd-platform';
    platform.textContent = item.platform || '未知平台';

    const cmd = document.createElement('div');
    cmd.className = 'cmd-text';
    cmd.textContent = item.command || '';

    const actions = document.createElement('div');
    actions.className = 'cmd-actions cmd-actions-inline';
    const copyBtn = document.createElement('button');
    copyBtn.className = 'btn-copy';
    copyBtn.textContent = '复制';
    copyBtn.addEventListener('click', () => {
      copyCommandText(item.command || '', copyBtn);
    });
    actions.appendChild(copyBtn);

    const entry = document.createElement('div');
    entry.className = 'cmd-entry';
    entry.appendChild(cmd);
    entry.appendChild(actions);

    row.appendChild(platform);
    row.appendChild(entry);
    list.appendChild(row);
  });

  section.classList.remove('hidden');
}

function renderError(state) {
  renderRole(state);
  const message = state && state.error ? state.error : '未知错误';
  document.getElementById('error-msg').textContent = message;

  const codeEl = document.getElementById('error-code');
  if (state && state.error_code) {
    codeEl.textContent = '错误码: ' + state.error_code;
    codeEl.classList.remove('hidden');
  } else {
    codeEl.textContent = '';
    codeEl.classList.add('hidden');
  }
}

function setPhase(phase, state) {
  const normalized = normalizePhase(phase);
  currentPhase = normalized;
  showPhase(normalized);

  if (normalized === 'config') {
    document.getElementById('btn-start').disabled = false;
    restoreConfigInputFromSession();
    renderRole(state || {});
  } else if (normalized === 'running') {
    renderRunning(state || {});
  } else if (normalized === 'error') {
    renderError(state || {});
  } else if (normalized === 'connecting') {
    renderConnecting(state || {});
  }

  syncPollersByPhase(normalized);
}

function applyServerState(state) {
  currentState = state || {};
  const nextPhase = normalizePhase(currentState.phase);
  if (nextPhase !== currentPhase) {
    setPhase(nextPhase, currentState);
    return;
  }

  if (nextPhase === 'running') {
    renderRunning(currentState);
  } else if (nextPhase === 'connecting') {
    renderConnecting(currentState);
  } else if (nextPhase === 'error') {
    renderError(currentState);
  } else {
    renderRole(currentState);
  }
}

function renderPeerInfo(snapshot) {
  const incoming = snapshot || null;
  if (hasPeerRows(incoming)) {
    lastNonEmptyPeerSnapshot = cloneSnapshot(incoming);
  }
  if (hasNonSelfPeerRows(incoming)) {
    lastNonSelfPeerSnapshot = cloneSnapshot(incoming);
    lastNonSelfPeerSnapshotAt = Date.now();
  }

  let displaySnapshot = cloneSnapshot(incoming);
  let stale = false;
  const cacheFresh = currentPhase === 'connecting' &&
    lastNonSelfPeerSnapshot &&
    (Date.now() - lastNonSelfPeerSnapshotAt <= CONNECTING_PEER_STALE_TTL_MS);

  if (!hasPeerRows(displaySnapshot) && currentPhase === 'connecting' && hasPeerRows(lastNonEmptyPeerSnapshot)) {
    displaySnapshot = cloneSnapshot(lastNonEmptyPeerSnapshot);
    stale = true;
  }
  if (currentPhase === 'connecting' && cacheFresh && hasPeerRows(displaySnapshot) && !hasNonSelfPeerRows(displaySnapshot)) {
    displaySnapshot = mergeSnapshotWithCachedNonSelf(displaySnapshot, lastNonSelfPeerSnapshot);
    stale = true;
  }
  if (!hasPeerRows(displaySnapshot) && currentPhase === 'connecting' && cacheFresh) {
    displaySnapshot = cloneSnapshot(lastNonSelfPeerSnapshot);
    stale = true;
  }
  if (!hasPeerRows(displaySnapshot) && currentPhase === 'connecting') {
    const fallback = buildConnectingFallbackSnapshot(currentState);
    if (hasPeerRows(fallback)) {
      displaySnapshot = fallback;
      stale = true;
    }
  }

  latestPeerSnapshot = displaySnapshot || null;
  const ownerFromSnapshot = displaySnapshot && displaySnapshot.network_owner ? String(displaySnapshot.network_owner) : '';
  const ownerFromState = currentState && currentState.network_owner ? String(currentState.network_owner) : '';
  const hashFromSnapshot = displaySnapshot && displaySnapshot.network_hash ? String(displaySnapshot.network_hash) : '';
  const hashFromState = currentState && currentState.network_hash ? String(currentState.network_hash) : '';
  updatePeerTitle(ownerFromSnapshot || ownerFromState, hashFromSnapshot || hashFromState);
  renderPeerTable(displaySnapshot, 'peer-table-body', 'peer-updated', stale);
  renderPeerTable(displaySnapshot, 'peer-table-body-connecting', 'peer-updated-connecting', stale);
}

async function hydrateState() {
  try {
    const resp = await fetch('/api/state');
    if (!resp.ok) throw new Error('state request failed');
    const state = await resp.json();
    applyServerState(state);
  } catch (e) {
    setPhase('config', {});
  }
}

async function boot() {
  bindConfigInputPersistence();
  restoreConfigInputFromSession();
  await hydrateState();
  syncPollersByPhase(currentPhase);
  if (currentPhase !== 'config') {
    await pollDebugLogs();
  }
  if (currentPhase === 'running') {
    await pollLogs();
    await pollPeerInfo();
  } else if (currentPhase === 'connecting') {
    await pollPeerInfo();
  }
}

async function submitConfig() {
  const input = document.getElementById('config-input').value.trim();
  if (!input) return;
  const btn = document.getElementById('btn-start');
  btn.disabled = true;
  document.getElementById('config-error').classList.add('hidden');

  try {
    const resp = await fetch('/api/submit-config', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({config: input})
    });
    const data = await resp.json();
    if (data.error) {
      document.getElementById('config-error').textContent = data.error;
      document.getElementById('config-error').classList.remove('hidden');
      btn.disabled = false;
      return;
    }
    clearConfigInputSession();
    document.getElementById('config-input').value = '';
    setPhase('connecting', {phase: 'connecting'});
    await pollState();
  } catch(e) {
    document.getElementById('config-error').textContent = '连接失败: ' + e.message;
    document.getElementById('config-error').classList.remove('hidden');
    btn.disabled = false;
  }
}

async function pollState() {
  try {
    const resp = await fetch('/api/state');
    if (!resp.ok) return;
    const state = await resp.json();
    applyServerState(state);
  } catch(e) {}
}

async function pollLogs() {
  try {
    const resp = await fetch('/api/logs');
    const logs = await resp.json();
    const area = document.getElementById('log-area');
    area.innerHTML = logs.map(l =>
      '<div class="log-line"><span class="log-time">' + l.time + '</span> ' +
      '<span class="log-method">' + l.method + '</span> ' +
      '<span class="log-path">' + l.path + '</span> ' +
      escapeHtml(l.summary) + '</div>'
    ).join('');
    area.scrollTop = area.scrollHeight;
  } catch(e) {}
}

async function pollDebugLogs() {
  try {
    const resp = await fetch('/api/debug-logs');
    const logs = await resp.json();
    cachedDebugLogs = Array.isArray(logs) ? logs : [];
    const areas = document.querySelectorAll('.debug-area');
    areas.forEach(a => { a.textContent = cachedDebugLogs.join('\n'); a.scrollTop = a.scrollHeight; });
  } catch(e) {}
}

async function pollPeerInfo() {
  try {
    const resp = await fetch('/api/peer-info');
    if (!resp.ok) return;
    const data = await resp.json();
    if (data.error) return;
    renderPeerInfo(data);
  } catch (e) {}
}

function copyDebugLogs(btn) {
  const text = cachedDebugLogs.join('\n');
  navigator.clipboard.writeText(text).then(() => {
    if (!btn) return;
    const orig = btn.textContent;
    btn.textContent = '已复制';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

function copyCommandText(text, btn) {
  const value = text ? String(text).trim() : '';
  if (!value) return;
  navigator.clipboard.writeText(value).then(() => {
    if (!btn) return;
    const orig = btn.textContent;
    btn.textContent = '已复制';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

function currentEndpoint() {
  if (currentState && currentState.virt_ip && typeof currentState.api_port === 'number' && currentState.api_port > 0) {
    return String(currentState.virt_ip) + ':' + String(currentState.api_port);
  }
  const text = document.getElementById('virt-ip').textContent || '';
  return text.trim();
}

function hasVirtualIPv4(value) {
  const ip = value ? String(value).trim() : '';
  if (!ip) return false;
  if (ip === '-') return false;
  return true;
}

function isClientRole(value) {
  const role = value ? String(value).trim().toLowerCase() : '';
  return role === 'client';
}

function buildAIPrompt(endpoint, peers) {
  const base = 'http://' + endpoint;
  const targets = Array.isArray(peers) ? peers : [];
  const targetLines = targets.map((p, idx) => {
    const ip = p && p.virtual_ipv4 ? String(p.virtual_ipv4) : '-';
    const host = p && p.hostname ? String(p.hostname) : '-';
    const role = p && p.role ? String(p.role) : '-';
    const latency = p && p.latency ? String(p.latency) : '-';
    return (idx + 1) + '. ' + ip + ' | ' + host + ' | role=' + role + ' | latency=' + latency;
  });
  return [
    '你现在可以通过 Telehand 远程协助 API 操作目标机器。',
    '连接信息: ' + endpoint,
    'API Base URL: ' + base,
    '候选目标:',
    targetLines.length > 0 ? targetLines.join('\n') : '-',
    '请先调用 GET ' + base + '/health，确认 phase=running。',
    '然后请查看 https://github.com/sfpprxy/telehand/blob/main/SKILL.md，并按该文档协议调用 API。'
  ].join('\n');
}

function copyConnectionInfo(btn) {
  const endpoint = currentEndpoint();
  if (!endpoint) return;
  navigator.clipboard.writeText(endpoint).then(() => {
    if (!btn) return;
    const orig = btn.textContent;
    btn.textContent = '已复制';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

function copyAIPromptForPeer(peer, btn) {
  const endpoint = currentEndpoint();
  if (!endpoint) return;
  if (!peer || !hasVirtualIPv4(peer.virtual_ipv4)) return;
  if (isClientRole(peer.role)) return;
  navigator.clipboard.writeText(buildAIPrompt(endpoint, [peer])).then(() => {
    if (!btn) return;
    const orig = btn.textContent;
    btn.textContent = '已复制';
    setTimeout(() => btn.textContent = orig, 1500);
  });
}

async function stopAgent() {
  stopAllPollers();
  clearConfigInputSession();
  try { await fetch('/api/stop', {method:'POST'}); } catch(e) {}
  document.querySelector('.container').innerHTML = '<h1>已断开</h1><p class="subtitle" style="margin-top:12px;">远程协助已结束，可以关闭此页面。</p>';
}

function showPhase(phase) {
  ['config','connecting','running','error'].forEach(p => {
    document.getElementById('phase-' + p).classList.toggle('hidden', p !== phase);
  });
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
