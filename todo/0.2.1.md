阅读 file:///Users/joe/Sync/Work/handoffs/telehand-handoff.md 并准备实现&发布 0.2.1

# 实现规则

自底向上的进行实现, 完成一个子任务后就用 Markdown 语法标记完成。但是如果在任何过程中遇到了问题，则在子任务下新建一个子任务并描述问题，解决完问题也标记完成。一般来说现有的任务内容不需要改动，如需改动停下来征求我同意。

# 0.2.1 目标：修复“已建立 EasyTier 连接但无法进入 running”的误判

## 已完成

- [x] 启动判定修复（核心）
  - [x] 固定复现并记录基线日志：`new peer added` 后仍轮转 candidate 的场景。
  - [x] 判定采用“连通性优先 + 冲突证据兜底”：已拿到 virt ip 且 peer 已建立时允许进入 running。
  - [x] 决策：`peer 已建立` 来源使用 `easytier-cli peer list` 非空（不依赖日志关键字）。
  - [x] 决策：进入 `running` 门槛为 `virt ip` + `peer 建立` + 对 peer 虚拟 IP 探测成功。
  - [x] 决策：冲突证据为“路由接口不一致 + 同 candidate 下连续失败（peer 查询失败）”。
  - [x] 决策：连续失败窗口采用 `3 次 / 5 秒`。

- [x] 状态机与可观测性
  - [x] `running` 保护窗口：默认 `5s`，窗口内异常仅告警，不回退。
  - [x] 保护窗口后仅在连续失败达阈值时从 `running` 进入 `error`。
  - [x] candidate 判定日志标准化：
    - [x] 格式：`candidate=<n>/<m> subnet=<cidr> result=<pass|warn|conflict> reason=<code> detail=<text>`
    - [x] reason 基础枚举：`peer_ready`、`route_mismatch`、`peer_query_failed`、`probe_timeout`
  - [x] 会话基线展示打通（CLI + Web）：
    - [x] `tun_device`、`virtual_subnet`、`network_hash` 字段一致

- [x] 测试基础
  - [x] 单测覆盖 3 场景：route 不一致但可连通、明确冲突、重试耗尽。
  - [x] 为 `QueryPeerReadiness` / `routeInterfaceForTarget` / `probePeerVirtualIP` 增加可注入依赖，支持稳定 mock。

## 待实现（按依赖顺序）

- [x] 连接稳定性改造：事件驱动优先 + 快照校准兜底（Event-first, Snapshot-reconcile）
  - [x] 问题：固定步长轮询（窗口 5s、step 3s）在 `new peer added -> peer removed` 抖动下易采样空窗，误判 `peer_not_ready` 并过早切 candidate。
  - [x] 决策：本次采用“状态接口轮询差分事件”作为事件来源（`node info` + `peer list` JSON）。
  - [x] 子任务：新增 `StatePoller`（单 goroutine，默认 500ms~1s）轮询并生成结构化 `Snapshot`。
  - [x] 子任务：新增 `DiffEngine`（`prev/curr Snapshot`）产出事件：`tun_ready` / `peer_added` / `peer_removed` / `endpoint_ready` / `process_exit`。
  - [x] 子任务：新增单线程连接 FSM：`starting -> tun_ready -> peer_seen -> endpoint_ready -> running`，连接阶段采用“差分事件触发 + 总超时”。
  - [x] 子任务：running 阶段采用“差分事件触发健康检查 + 低频兜底校准（10-15s）”，保留现有 5s 保护窗口与连续失败阈值。
  - [x] 子任务：日志去抖与限流：同类事件 500ms 合并；同 reason/detail 10s 最多一条。
  - [x] 子任务：测试补齐（fake snapshot stream）：add/remove 抖动、bootstrap_only、endpoint_ready、process_exit、总超时。

- [x] 路由防抢占（避免 `10.x` 流量被更高优先级路由接走）
  - [x] 问题：多 VPN/TUN 共存时，`10.x` 流量可能走非当前 TUN；仅靠连接窗口判定无法保证“目标 peer 流量一定走本会话 TUN”。
  - [x] 决策：不做“调整 EasyTier TUN metric”（影响面大，可能误伤其他流量）。
  - [x] 子任务：候选网段选择增加“系统路由表占用检测”，避开已占用 `10.x` 路由段（不只看本机接口地址）。
  - [x] 子任务：拿到目标 peer 虚拟 IP 后自动下发 `/32` 主机路由绑定当前 TUN（优先于泛化 `10.x` 路由）。
  - [x] 子任务：会话停止/切 candidate 时清理本会话下发的 `/32` 主机路由。

## 验证与发布

- [ ] 实机验证：同机并行 `easytier-gui` + `telehand` 可稳定通过连接流程（目标：不出现卡 16 轮现象）。
