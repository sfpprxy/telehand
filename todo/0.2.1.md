阅读 file:///Users/joe/Sync/Work/handoffs/telehand-handoff.md 并准备实现&发布 0.2.1

# 实现规则

自底向上的进行实现, 完成一个子任务后就用 Markdown 语法标记完成。但是如果在任何过程中遇到了问题，则在子任务下新建一个子任务并描述问题，解决完问题也标记完成。一般来说现有的任务内容不需要改动，如需改动停下来征求我同意。

# 0.2.1 目标：修复“已建立 EasyTier 连接但无法进入 running”的误判

目标分解：
- [x] 启动判定修复（核心）
  - [x] 固定复现并记录基线日志：`new peer added` 后仍轮转 candidate 的场景
  - [x] 将判定改为“连通性优先 + 冲突证据兜底”：已拿到 virt ip 且 peer 已建立时允许进入 running
    - 要求/标准：`running` 放行条件必须可代码化，不能依赖“人工看日志判断”
    - 要求/标准：单一信号失败（例如 route interface 不一致）不能直接阻断 `running`
    - 决策：`peer 已建立` 的判定来源使用 `easytier-cli peer list` 非空（不依赖日志关键字）。
    - 决策：进入 `running` 的门槛为 `virt ip` 已获取 + `peer 已建立` + 连通性探测成功（对 peer 虚拟 IP 做短探测）。
    - 决策：明确冲突证据为“路由接口不一致 + 同一 candidate 下连续失败（peer 查询失败）”。
    - 决策：连续失败窗口采用 `3 次 / 5 秒`。

- [x] 状态机与可观测性
  - 要求/标准：进入 `running` 后，瞬时路由波动只能记告警，不得立即回退 `connecting`
  - 要求/标准：candidate 判定日志必须可检索且可归因，包含“候选子网 + 判定结果 + 判定证据”
  - 要求/标准：会话基线需在 CLI 与 Web 同步可见，字段一致（`tun_device` / `virtual_subnet` / `network_hash`）
  - [x] 状态机保护窗口
    - [x] 增加 `running` 保护窗口（默认 `5s`）：窗口内路由异常仅告警，不触发状态回退
    - [x] 超出保护窗口后，只有“连续失败达到阈值”才允许从 `running` 进入 `error`
  - [x] candidate 判定日志标准化
    - [x] 统一输出格式：`candidate=<n>/<m> subnet=<cidr> result=<pass|warn|conflict> reason=<code> detail=<text>`
    - [x] `reason` 枚举最少包含：`peer_ready`、`route_mismatch`、`peer_query_failed`、`probe_timeout`
  - [x] 会话基线展示打通
    - [x] 后端状态中新增/补齐基线字段：`tun_device`、`virtual_subnet`、`network_hash`
    - [x] Web 页面新增 “Session Baseline” 展示区，显示上述 3 个字段
    - [x] CLI 在进入 `running` 时打印同一组字段，键名与 Web 保持一致

- [ ] 测试与发布
  - [x] 单测覆盖 3 个场景：route 不一致但可连通、明确冲突、重试耗尽
    - [x] 问题：当前测试基建缺少 EasyTier CLI/路由探测的可注入 mock 点，难以稳定构造“route 不一致 + peer 查询失败窗口”三类判定路径。
      - [x] 子任务：为 `QueryPeerReadiness` / `routeInterfaceForTarget` / `probePeerVirtualIP` 增加可注入依赖（函数变量或接口），再补齐 3 类单测。
  - [ ] 实机验证同机并行 `easytier-gui` + `telehand` 不再卡 16 轮
